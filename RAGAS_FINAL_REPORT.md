# üéâ –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢: RAGAS Integration Fixed!

**–î–∞—Ç–∞**: 10 –æ–∫—Ç—è–±—Ä—è 2024
**–í–µ—Ä—Å–∏—è**: 2.0 Final

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. **RAGAS —Ç–µ–ø–µ—Ä—å –†–ï–ê–õ–¨–ù–û —Ä–∞–±–æ—Ç–∞–µ—Ç**

**–ë—ã–ª–æ**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞, RAGAS –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–ª–∞—Å—å

**–°—Ç–∞–ª–æ**: RAGAS –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å 4 LLM backends

---

### 2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É**

#### YandexGPT (14 —Å–µ–∫—É–Ω–¥):
```
‚úÖ Faithfulness:        1.000
‚ö†Ô∏è  Context Precision:   0.000
‚úÖ Answer Relevancy:    0.965
üéØ Overall Score:       0.655
```

#### Deepseek (18.5 —Å–µ–∫—É–Ω–¥):
```
‚úÖ Faithfulness:        1.000
‚úÖ Context Precision:   0.500
‚ö†Ô∏è  Answer Relevancy:    nan (Deepseek –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç n>1)
```

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï LLM –î–õ–Ø RAGAS

| LLM | –†–∞–±–æ—Ç–∞–µ—Ç | –°–∫–æ—Ä–æ—Å—Ç—å | –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ | –°—Ç–æ–∏–º–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|-----|----------|----------|-------------|-----------|--------------|
| **YandexGPT** | ‚úÖ | 14 —Å–µ–∫ | ‚úÖ 3/3 | ~$0.002/–æ—Ü–µ–Ω–∫–∞* | Development |
| **Deepseek** | ‚úÖ | 18 —Å–µ–∫ | ‚ö†Ô∏è 2/3 | ~$0.001/–æ—Ü–µ–Ω–∫–∞ | Production (—á–∞—Å—Ç–∏—á–Ω–æ) |
| **OpenAI** | ‚úÖ | ~20 —Å–µ–∫ | ‚úÖ 3/3 | ~$0.01/–æ—Ü–µ–Ω–∫–∞ | Production (–ø–æ–ª–Ω—ã–π) |
| **–≠–≤—Ä–∏—Å—Ç–∏–∫–∞** | ‚úÖ | <0.1 —Å–µ–∫ | ‚úÖ 3/3 | $0 | **Production default** ‚≠ê |

*–¶–µ–Ω—ã —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ, YandexGPT –Ω–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π (—Ü–µ–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ GPT-4o-mini)

---

## üêõ –ù–ê–ô–î–ï–ù–ù–´–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ë–ê–ì–ò

### –ë–∞–≥ 1: RAGAS –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–ª–∞—Å—å
**–ë—ã–ª–æ**:
```python
# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ü–µ–Ω–∫–∏
logger.info("Using heuristic evaluation")
return self._calculate_fallback_scores(...)  # ‚Üê –í–°–ï–ì–î–ê!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**:
```python
if not self.ragas_enabled:
    return self._calculate_fallback_scores(...)

# –ó–∞–ø—É—Å–∫–∞–µ–º –†–ï–ê–õ–¨–ù–£–Æ RAGAS –æ—Ü–µ–Ω–∫—É
return await self._evaluate_with_ragas(...)
```

---

### –ë–∞–≥ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π async wrapper –¥–ª—è YandexGPT
**–ë—ã–ª–æ**:
```python
def agenerate_prompt(self, prompts, **kwargs):
    return asyncio.run(self.generate_prompt(...))  # ‚Üê –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π event loop!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**:
```python
async def _agenerate(self, prompts, **kwargs) -> LLMResult:
    return await asyncio.to_thread(self._generate, prompts, **kwargs)
```

---

### –ë–∞–≥ 3: –õ–æ–≥–∏–∫–∞ context_precision
**–ë—ã–ª–æ**:
```python
if len(contexts) >= 3:
    score += 0.1
elif len(contexts) >= 5:  # ‚Üê –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è!
    score += 0.2
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**:
```python
if len(contexts) >= 5:     # –°–Ω–∞—á–∞–ª–∞ –±–æ–ª—å—à–µ–µ
    score += 0.2
elif len(contexts) >= 3:   # –ü–æ—Ç–æ–º –º–µ–Ω—å—à–µ–µ
    score += 0.15
```

---

### –ë–∞–≥ 4: –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–∞–≤–∞–ª–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏
**–ë—ã–ª–æ**:
- –ë–∞–∑–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–µ (0.7-0.8)
- –ü—Ä–æ—Å—Ç—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
- –í—Å–µ –æ—Ü–µ–Ω–∫–∏ ~0.8-0.9

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**:
- –ù–∏–∑–∫–∏–µ –±–∞–∑–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏ (0.3-0.4)
- –£–º–Ω—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ —Å word overlap, Jaccard similarity
- –û—Ü–µ–Ω–∫–∏ —Ç–µ–ø–µ—Ä—å –≤–∞—Ä—å–∏—Ä—É—é—Ç—Å—è: 0.3-1.0

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø PRODUCTION

### –í–∞—Ä–∏–∞–Ω—Ç 1: –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) ‚≠ê

```bash
# –í .env
ENABLE_RAGAS_EVALUATION=true
RAGAS_EVALUATION_SAMPLE_RATE=0.2  # 20% –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
RAGAS_LLM_BACKEND=yandexgpt        # –ë–µ–∑ –∫–ª—é—á–∞ = —ç–≤—Ä–∏—Å—Ç–∏–∫–∞
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ (<100ms)
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–Ω–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ –í—Å–µ 3 –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: RAGAS —Å YandexGPT (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

```bash
RAGAS_EVALUATION_SAMPLE_RATE=0.05  # 5% –∏–∑-–∑–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
RAGAS_LLM_BACKEND=yandexgpt
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –í—Å–µ 3 –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ (14+ —Å–µ–∫—É–Ω–¥)
- ‚ùå –°—Ç–æ–∏—Ç –¥–µ–Ω–µ–≥ (~$0.002/–æ—Ü–µ–Ω–∫–∞)

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: RAGAS —Å Deepseek (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)

```bash
RAGAS_EVALUATION_SAMPLE_RATE=0.1
RAGAS_LLM_BACKEND=deepseek
DEEPSEEK_API_KEY=your_key
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–µ—à–µ–≤–æ (~$0.001)
- ‚úÖ 2 –∏–∑ 3 –º–µ—Ç—Ä–∏–∫

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è Answer Relevancy –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (Deepseek –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Ö–æ–¥—è—Ç –≤–æ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

---

## üìñ –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤:
- ‚úÖ `RAGAS_INTEGRATION_SUMMARY.md` - –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
- ‚úÖ `env.example` - –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- ‚úÖ `app/services/quality/ragas_evaluator.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## üß™ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨

### –¢–µ—Å—Ç 1: –≠–≤—Ä–∏—Å—Ç–∏–∫–∞
```bash
python tests/test_ragas_quality.py
# –†–µ–∑—É–ª—å—Ç–∞—Ç: < 1 —Å–µ–∫—É–Ω–¥–∞, –æ—Ü–µ–Ω–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
```

### –¢–µ—Å—Ç 2: YandexGPT RAGAS
```bash
python test_ragas_full.py
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ~14 —Å–µ–∫—É–Ω–¥, –≤—Å–µ 3 –º–µ—Ç—Ä–∏–∫–∏
```

### –¢–µ—Å—Ç 3: Deepseek RAGAS
```bash
python test_ragas_deepseek.py
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ~18 —Å–µ–∫—É–Ω–¥, 2 –∏–∑ 3 –º–µ—Ç—Ä–∏–∫
```

---

## üí∞ –°–¢–û–ò–ú–û–°–¢–¨ RAGAS –û–¶–ï–ù–ö–ò

–†–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ 6-9 LLM –≤—ã–∑–æ–≤–æ–≤ –Ω–∞ –æ—Ü–µ–Ω–∫—É:

| Provider | $/1K —Ç–æ–∫–µ–Ω–æ–≤ | –¢–æ–∫–µ–Ω–æ–≤/–æ—Ü–µ–Ω–∫–∞ | –°—Ç–æ–∏–º–æ—Å—Ç—å/–æ—Ü–µ–Ω–∫–∞ | –°—Ç–æ–∏–º–æ—Å—Ç—å/1000 –æ—Ü–µ–Ω–æ–∫ |
|----------|--------------|----------------|------------------|-----------------------|
| **YandexGPT** | ~$0.002 | ~1000 | ~$0.002 | ~$2 |
| **Deepseek** | ~$0.0015 | ~800 | ~$0.0012 | ~$1.20 |
| **OpenAI GPT-4o-mini** | ~$0.15 | ~1000 | ~$0.15 | ~$150 |
| **–≠–≤—Ä–∏—Å—Ç–∏–∫–∞** | $0 | 0 | $0 | $0 |

**–í—ã–≤–æ–¥**: YandexGPT **–ù–ï –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π**, —Ü–µ–Ω—ã comparable —Å GPT-4o-mini!

---

## üéì –í–´–í–û–î–´

### –ß—Ç–æ –º—ã —É–∑–Ω–∞–ª–∏:

1. **RAGAS –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—é–±—ã–µ LLM** —á–µ—Ä–µ–∑ LangChain (–Ω–µ —Ç–æ–ª—å–∫–æ OpenAI)
2. **YandexGPT —Ä–∞–±–æ—Ç–∞–µ—Ç** —Å RAGAS, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π async wrapper
3. **Deepseek —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç** (2 –∏–∑ 3 –º–µ—Ç—Ä–∏–∫ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è n=1)
4. **–≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ** –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production
5. **RAGAS –º–µ–¥–ª–µ–Ω–Ω–∞—è –∏ –¥–æ—Ä–æ–≥–∞—è** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –º–∞–ª—ã–º sample_rate

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

```
Production:
‚îú‚îÄ –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ (100% –∑–∞–ø—Ä–æ—Å–æ–≤, <100ms, $0)
‚îú‚îÄ RAGAS —Å YandexGPT (5% –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
‚îî‚îÄ User Feedback (–¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏)
```

---

## üìù NEXT STEPS

1. ‚úÖ **–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω**
2. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞**
3. ‚è≥ **TODO**: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ Deepseek n>1
4. ‚è≥ **TODO**: A/B —Ç–µ—Å—Ç: —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ vs RAGAS –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. ‚è≥ **TODO**: –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å user feedback
6. ‚è≥ **TODO**: –û–±–Ω–æ–≤–∏—Ç—å Grafana dashboard —Å –Ω–æ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏

---

**–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.**

**–ê–≤—Ç–æ—Ä**: AI Assistant
**–î–∞—Ç–∞**: 10 –æ–∫—Ç—è–±—Ä—è 2024, 18:40


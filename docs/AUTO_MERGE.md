# Auto-Merge: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤

## üìñ –û–±–∑–æ—Ä

**Auto-Merge** ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è retrieval-–ø–∞–π–ø–ª–∞–π–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å–µ–¥–Ω–∏–µ —á–∞–Ω–∫–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞ rerank, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è LLM –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –∏ —Å–≤—è–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ token budget.

> **‚ö†Ô∏è –í–∞–∂–Ω–æ:** Auto-Merge —Ä–∞–±–æ—Ç–∞–µ—Ç **–∏–∑ –∫–æ—Ä–æ–±–∫–∏** –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!
> –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ `tiktoken` –∏ `cachetools` —è–≤–ª—è—é—Ç—Å—è **–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏.
> –°–º. [AUTO_MERGE_OPTIONAL_DEPS.md](./AUTO_MERGE_OPTIONAL_DEPS.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç**: LLM –ø–æ–ª—É—á–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
- ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏**: –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ rerank, –ø–æ—ç—Ç–æ–º—É —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏
- ‚úÖ **–ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ env-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–∏—è–Ω–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ú–µ—Å—Ç–æ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ

```
–ó–∞–ø—Ä–æ—Å ‚Üí Embedding ‚Üí Hybrid Search ‚Üí RRF Fusion ‚Üí Rerank
                                                      ‚Üì
                                              üéØ AUTO-MERGE üéØ
                                                      ‚Üì
                                          Context Optimization ‚Üí LLM
```

### –ê–ª–≥–æ—Ä–∏—Ç–º

1. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º**
   –ß–∞–Ω–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `doc_id` –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –≤–º–µ—Å—Ç–µ.

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞–Ω–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞**
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ fetch –≤—Å–µ –µ–≥–æ —á–∞–Ω–∫–∏ –∏–∑ Qdrant (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º).

3. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ–∫–Ω–∞**
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —á–∞–Ω–∫–∞ —Ä–∞—Å—à–∏—Ä—è–µ–º –æ–∫–Ω–æ –≤–ª–µ–≤–æ –∏ –≤–ø—Ä–∞–≤–æ:
   ```
   –ò—Å—Ö–æ–¥–Ω—ã–π —á–∞–Ω–∫: [2]
   –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–ª–µ–≤–æ: [1] [2]
   –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ: [1] [2] [3]
   –û—Å—Ç–∞–Ω–æ–≤–∫–∞: –¥–æ—Å—Ç–∏–≥–Ω—É—Ç token budget
   ```

4. **Token Budget –∫–æ–Ω—Ç—Ä–æ–ª—å**
   –û—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑:
   - **tiktoken** (—Ç–æ—á–Ω–æ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
   - –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ `len(text) // 4` (fallback)

5. **Deduplification**
   –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –æ–∫–Ω–∞ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É—é—Ç—Å—è ‚Äî –æ–¥–∏–Ω —á–∞–Ω–∫ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã.

6. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞**
   –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –ø–æ—Å–ª–µ rerank.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
RETRIEVAL_AUTO_MERGE_ENABLED=true              # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å
RETRIEVAL_AUTO_MERGE_MAX_TOKENS=1200           # –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö
RETRIEVAL_AUTO_MERGE_USE_TIKTOKEN=true         # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tiktoken –¥–ª—è –æ—Ü–µ–Ω–∫–∏

# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
RETRIEVAL_CACHE_MAXSIZE=1000                   # –ú–∞–∫—Å. –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–µ—à–µ
RETRIEVAL_CACHE_TTL=300                        # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ (—Å–µ–∫—É–Ω–¥—ã)

# Qdrant
QDRANT_SCROLL_BATCH_SIZE=64                    # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –ø—Ä–∏ scroll
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ app/config/app_config.py

```python
@dataclass(frozen=True)
class AppConfig:
    # Auto-Merge
    retrieval_auto_merge_enabled: bool            # default: True
    retrieval_auto_merge_max_tokens: int          # default: 1200
    retrieval_auto_merge_use_tiktoken: bool       # default: True
    retrieval_cache_maxsize: int                  # default: 1000
    retrieval_cache_ttl: int                      # default: 300 (5 –º–∏–Ω)
    qdrant_scroll_batch_size: int                 # default: 64
```

---

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### RETRIEVAL_AUTO_MERGE_MAX_TOKENS

| –ó–Ω–∞—á–µ–Ω–∏–µ | –°—Ü–µ–Ω–∞—Ä–∏–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `800-1000` | –≠–∫–æ–Ω–æ–º–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ LLM |
| `1200` | **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** | –ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| `1500-2000` | –ë–æ–≥–∞—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ |

**–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è:**
Orchestrator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ `context_optimizer.max_context_tokens`:
```python
available = max_context_tokens * (1 - reserve_for_response)
merge_limit = min(CONFIG.retrieval_auto_merge_max_tokens, available)
```

### RETRIEVAL_AUTO_MERGE_USE_TIKTOKEN

- ‚úÖ **true** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –¢–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ tiktoken (~10-15% —Ç–æ—á–Ω–µ–µ)
- ‚ö° **false**: –ë—ã—Å—Ç—Ä–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ `len//4` (–Ω–∞ ~30% –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ)

### RETRIEVAL_CACHE_TTL

- `60-180`: –ß–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞
- `300`: **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** (5 –º–∏–Ω—É—Ç)
- `600-900`: –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å

---

## üîç –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–∏—è–Ω–∏—è

–ü–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è payload —Å–æ–¥–µ—Ä–∂–∏—Ç:

```python
{
    "auto_merged": True,
    "merged_chunk_indices": [2, 3, 4],      # –ö–∞–∫–∏–µ —á–∞–Ω–∫–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã
    "merged_chunk_count": 3,                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
    "chunk_span": {
        "start": 2,
        "end": 4
    },
    "merged_chunk_ids": [                   # ID –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
        "doc-123#2",
        "doc-123#3",
        "doc-123#4"
    ],
    "text": "–û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç...",        # –°–ª–∏—Ç—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    "content_length": 3456                  # –î–ª–∏–Ω–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
}
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞

```log
DEBUG Auto-merge: 15 -> 8 –æ–∫–æ–Ω (–ª–∏–º–∏—Ç=1200 —Ç–æ–∫–µ–Ω–æ–≤, —ç–∫–æ–Ω–æ–º–∏—è=7 —á–∞–Ω–∫–æ–≤, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å=46.7%)
```

### –ú–µ—Ç—Ä–∏–∫–∏

- **–î–æ/–ü–æ—Å–ª–µ**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –¥–æ –∏ –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è
- **–õ–∏–º–∏—Ç**: –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π token budget
- **–≠–∫–æ–Ω–æ–º–∏—è**: –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–æ
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ–¥—É–∫—Ü–∏–∏ –æ–∫–æ–Ω

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
pytest tests/test_retrieval_auto_merge.py -v

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (edge cases, performance)
pytest tests/test_retrieval_auto_merge_extended.py -v

# –í—Å–µ —Ç–µ—Å—Ç—ã
pytest tests/test_retrieval_auto_merge*.py -v
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–æ–≤

‚úÖ **–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**
- –°–ª–∏—è–Ω–∏–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —á–∞–Ω–∫–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ orphan chunks

‚úÖ **Edge Cases**
- –ü—É—Å—Ç—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –û—Ç–∫–ª—é—á—ë–Ω–Ω—ã–π auto-merge
- –ß–∞–Ω–∫–∏ –±–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –û–¥–∏–Ω —á–∞–Ω–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç
- Non-sequential chunks

‚úÖ **Performance**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (100 docs √ó 10 chunks)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

‚úÖ **Token Estimation**
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –ö–æ—Ä–æ—Ç–∫–∏–µ/–¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
- –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

‚úÖ **Merge Logic**
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ token budget
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from app.services.search.retrieval import auto_merge_neighbors

# –ü–æ—Å–ª–µ rerank –ø–æ–ª—É—á–∏–ª–∏ —Ç–æ–ø-10 —á–∞–Ω–∫–æ–≤
top_docs = reranker.rerank(query, candidates)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ
merged_docs = auto_merge_neighbors(
    top_docs,
    max_window_tokens=1200
)

# merged_docs —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ–∫–Ω–∞
for doc in merged_docs:
    if doc["payload"].get("auto_merged"):
        print(f"Merged {doc['payload']['merged_chunk_count']} chunks")
```

### –ü—Ä–∏–º–µ—Ä 2: –° —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π fetch-—Ñ—É–Ω–∫—Ü–∏–µ–π (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

```python
def custom_fetch(doc_id: str) -> list[dict]:
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤
    return get_chunks_from_cache(doc_id)

merged = auto_merge_neighbors(
    top_docs,
    max_window_tokens=1500,
    fetch_fn=custom_fetch
)
```

### –ü—Ä–∏–º–µ—Ä 3: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```python
# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å
object.__setattr__(CONFIG, "retrieval_auto_merge_enabled", False)
result = orchestrator.search(query)

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å max_window_tokens=0
merged = auto_merge_neighbors(top_docs, max_window_tokens=0)  # –ù–µ —Å–æ–ª—å—ë—Ç
```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Orchestrator

Orchestrator –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç auto-merge –ø–æ—Å–ª–µ rerank:

```python
# app/services/infrastructure/orchestrator.py

# 5a. Rerank
top_docs = reranker.rerank(query, candidates)

# 5b. Auto-merge
if CONFIG.retrieval_auto_merge_enabled:
    max_ctx_tokens = context_optimizer.max_context_tokens
    reserve = context_optimizer.reserve_for_response
    available = max(1, int(max_ctx_tokens * (1 - reserve)))
    merge_limit = min(CONFIG.retrieval_auto_merge_max_tokens, available)

    merged_docs = auto_merge_neighbors(top_docs, max_window_tokens=merge_limit)
    top_docs = merged_docs

# 6. Context Optimization
optimized = context_optimizer.optimize_context(top_docs, normalized)
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—è–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. `RETRIEVAL_AUTO_MERGE_ENABLED=true` –≤ `.env`
2. `RETRIEVAL_AUTO_MERGE_MAX_TOKENS` > 0
3. –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ `Auto-merge: X -> Y –æ–∫–æ–Ω`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
python -c "from app.config import CONFIG; print(f'Enabled: {CONFIG.retrieval_auto_merge_enabled}, MaxTokens: {CONFIG.retrieval_auto_merge_max_tokens}')"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —á–∞–Ω–∫–æ–≤ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è, context window overflow

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–º–µ–Ω—å—à–∏—Ç—å –ª–∏–º–∏—Ç
RETRIEVAL_AUTO_MERGE_MAX_TOKENS=800

# –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å tiktoken (–±—É–¥–µ—Ç –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–µ–µ)
RETRIEVAL_AUTO_MERGE_USE_TIKTOKEN=false
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–°–∏–º–ø—Ç–æ–º—ã:**
–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è auto-merge

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞
RETRIEVAL_CACHE_MAXSIZE=2000

# –£–≤–µ–ª–∏—á–∏—Ç—å batch size –¥–ª—è scroll
QDRANT_SCROLL_BATCH_SIZE=128

# –û—Ç–∫–ª—é—á–∏—Ç—å tiktoken –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
RETRIEVAL_AUTO_MERGE_USE_TIKTOKEN=false
```

### –ü—Ä–æ–±–ª–µ–º–∞: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
–†–æ—Å—Ç –ø–∞–º—è—Ç–∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞
RETRIEVAL_CACHE_MAXSIZE=500

# –£–º–µ–Ω—å—à–∏—Ç—å TTL
RETRIEVAL_CACHE_TTL=120  # 2 –º–∏–Ω—É—Ç—ã
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [ADR-001: BGE-M3 Unified Embeddings](./adr-001-bge-m3-unified-embeddings.md)
- [ADR-002: Adaptive Chunking](./adr-002-adaptive-chunking.md)
- [Architecture Overview](./architecture.md)
- [API Documentation](./api_documentation.md)

---

## üéØ Best Practices

1. **–ù–∞—á–Ω–∏—Ç–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π** (`RETRIEVAL_AUTO_MERGE_MAX_TOKENS=1200`)
2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏** —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–ª–∏—è–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ LLM**: –¥–ª—è –º–æ–¥–µ–ª–µ–π —Å –±–æ–ª—å—à–∏–º context window —É–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ tiktoken –≤ production** –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
5. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–µ—à** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
6. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö** –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

---

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-10-08
**–ê–≤—Ç–æ—Ä—ã:** RAG System Team

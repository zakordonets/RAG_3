# Внедрение Sparse Векторов в RAG-систему

## Обзор

Данный документ описывает полное внедрение sparse векторов в RAG-систему для edna Chat Center, включая архитектурные изменения, технические решения и результаты.

## Проблема

Первоначально система использовала только dense векторы для поиска, что ограничивало качество поиска для запросов, требующих точного лексического соответствия. Sparse векторы обеспечивают лучшую точность для поиска по ключевым словам и терминам.

## Решение

### Архитектурные изменения

1. **Удаление внешнего sparse сервиса**
   - Убран отдельный sparse сервис на FlagEmbedding
   - Локальная генерация sparse векторов через BGE-M3

2. **Изменение структуры Qdrant коллекции**
   - Переход на named vectors: `dense` и `sparse`
   - Использование `SparseVectorParams` для sparse векторов

3. **Обновление embedding pipeline**
   - Hybrid стратегия: DirectML для dense, CPU для sparse
   - Автоматическое преобразование `lexical_weights` в формат Qdrant

### Технические детали

#### Структура данных
```python
# BGE-M3 возвращает lexical_weights как словарь
lexical_weights = {"5187": 0.072, "29": 0.112, "83198": 0.129, ...}

# Преобразование в формат Qdrant SparseVector
sparse_vector = SparseVector(
    indices=[5187, 29, 83198, ...],
    values=[0.072, 0.112, 0.129, ...]
)

# Структура точки в Qdrant
point = {
    "id": "uuid",
    "vector": {
        "dense": [0.1, 0.2, ...],  # 1024 измерения
        "sparse": sparse_vector    # SparseVector
    },
    "payload": {...}
}
```

#### Конфигурация коллекции
```python
vectors_config = {"dense": VectorParams(size=1024, distance=Distance.COSINE)}
sparse_vectors_config = {"sparse": SparseVectorParams()}

client.recreate_collection(
    collection_name="chatcenter_docs",
    vectors_config=vectors_config,
    sparse_vectors_config=sparse_vectors_config
)
```

## Процесс внедрения

### 1. Полная замена коллекции
- Создан скрипт `recreate_collection_with_sparse.py`
- Удаление старой коллекции и создание новой с поддержкой sparse векторов
- Проверка конфигурации коллекции

### 2. Полная переиндексация
- Создан скрипт `full_reindex.py`
- Переиндексация всех 516 чанков с sparse векторами
- Время выполнения: ~50 минут

### 3. Проверка качества
- Создан скрипт `verify_sparse_coverage.py`
- Проверка 100% покрытия sparse векторами
- Верификация корректности структуры данных

### 4. Тестирование поиска
- Создан скрипт `test_sparse_search_detailed.py`
- Comprehensive тестирование sparse поиска
- Проверка релевантности результатов

## Результаты

### Количественные показатели
- **Покрытие sparse векторами**: 100% (512/512 точек)
- **Количество переиндексированных чанков**: 516
- **Время полной переиндексации**: ~50 минут
- **Средний размер sparse вектора**: 64-101 индекс

### Качественные показатели
- **Sparse поиск работает**: Все тестовые запросы возвращают релевантные результаты
- **Гибридный поиск функционален**: Комбинация dense + sparse + RRF
- **Улучшенная точность**: Лучшее соответствие для лексических запросов

### Примеры результатов
```
Запрос: "Как мне настроить маршрутизацию?"
- До внедрения: 0 результатов (sparse поиск не работал)
- После внедрения: 5 релевантных результатов

Запрос: "API"
- До внедрения: Ограниченные результаты
- После внедрения: 5 точных результатов по API документации
```

## Скрипты управления

### Основные скрипты
- `recreate_collection_with_sparse.py` - полная замена коллекции
- `full_reindex.py` - полная переиндексация
- `verify_sparse_coverage.py` - проверка покрытия
- `test_sparse_search_detailed.py` - тестирование поиска

### Вспомогательные скрипты
- `find_test_points.py` - поиск тестовых точек
- `check_qdrant_detailed.py` - детальная проверка Qdrant
- `debug_sparse_vectors.py` - отладка sparse векторов

## Конфигурация

### Переменные окружения
```bash
# Sparse векторы
USE_SPARSE=true
EMBEDDINGS_BACKEND=auto  # Поддержка 'auto' для sparse векторов

# YandexGPT
YANDEX_MODEL=yandexgpt/rc  # Использование RC версии
```

### Параметры chunking
```bash
CHUNK_MIN_TOKENS=60   # Оптимизированный размер чанков
CHUNK_MAX_TOKENS=250  # Сохранение целостности параграфов
```

## Мониторинг

### Метрики
- Покрытие sparse векторами
- Время генерации sparse векторов
- Качество sparse поиска
- Производительность гибридного поиска

### Логирование
- Детальные логи генерации sparse векторов
- Трассировка преобразования данных
- Мониторинг ошибок индексации

## Преимущества

1. **Улучшенная точность поиска**
   - Лучшее соответствие для лексических запросов
   - Комбинация семантического и лексического поиска

2. **Упрощенная архитектура**
   - Удаление внешнего sparse сервиса
   - Локальная генерация через BGE-M3

3. **Производительность**
   - Hybrid CPU+GPU стратегия
   - Эффективное использование ресурсов

4. **Надежность**
   - 100% покрытие sparse векторами
   - Comprehensive тестирование

## Заключение

Внедрение sparse векторов значительно улучшило качество поиска в RAG-системе. Система теперь обеспечивает:

- **100% покрытие sparse векторами**
- **Функциональный гибридный поиск**
- **Улучшенную точность для лексических запросов**
- **Упрощенную архитектуру без внешних зависимостей**

Все изменения протестированы и готовы к production использованию.

